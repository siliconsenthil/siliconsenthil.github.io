<!doctype html><html class="not-ready text-sm lg:text-base" style=--bg:#f1efe1 lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>VCR - Match body - siliconsenthil</title><meta name=theme-color><meta name=description content="We had to have make external API calls and we used vcr to record and replay in our integration tests. All was going on well.
Despite this coverage, we saw our code breaking in production due to small chages in request xml body. We wanted our integration spec to cover these too. By default, vcr matches request method and url. We wanted it to match the post body too. Simple match by body does not solve as it does plain string match."><meta name=author content><link rel="preload stylesheet" as=style href=https://siliconsenthil.in/main.min.css><script defer src=https://siliconsenthil.in/highlight.min.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=preload as=image href=https://siliconsenthil.in/theme.png><link rel=preload as=image href=https://www.gravatar.com/avatar/b78415ec052d8811a4f31c4746cbde9f><link rel=preload as=image href=https://siliconsenthil.in/twitter.svg><link rel=preload as=image href=https://siliconsenthil.in/github.svg><link rel=preload as=image href=https://siliconsenthil.in/rss.svg><link rel=icon href=https://siliconsenthil.in/favicon.ico><link rel=apple-touch-icon href=https://siliconsenthil.in/apple-touch-icon.png><meta name=generator content="Hugo 0.101.0"><meta property="og:title" content="VCR - Match body"><meta property="og:description" content="How to write a custom matcher for VCR to match http post body"><meta property="og:type" content="article"><meta property="og:url" content="https://siliconsenthil.in/blog/2014-04-02-vcr-match-body/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2014-04-02T18:50:00+05:30"><meta property="article:modified_time" content="2014-04-02T18:50:00+05:30"><meta itemprop=name content="VCR - Match body"><meta itemprop=description content="How to write a custom matcher for VCR to match http post body"><meta itemprop=datePublished content="2014-04-02T18:50:00+05:30"><meta itemprop=dateModified content="2014-04-02T18:50:00+05:30"><meta itemprop=wordCount content="190"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="VCR - Match body"><meta name=twitter:description content="How to write a custom matcher for VCR to match http post body"></head><body class="text-black duration-200 ease-out dark:text-white"><header class="mx-auto flex h-[5rem] max-w-3xl px-8 lg:justify-center"><div class="relative z-50 mr-auto flex items-center"><a class="-translate-x-[1px] -translate-y-0.5 text-3xl font-bold" href=https://siliconsenthil.in/>siliconsenthil</a>
<a class="btn-dark ml-6 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]"></a></div><a class="btn-menu relative z-50 -mr-8 flex h-[5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"></a>
<script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg=`"#f1efe1"`.replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)"),darkVal=localStorage.getItem("dark");setDark(darkVal?darkVal==="true":darkScheme.matches),darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"><nav class="mt-12 flex justify-center space-x-10 dark:invert lg:mt-0 lg:ml-12 lg:items-center lg:space-x-6"><a class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./twitter.svg) href=https://twitter.com/siliconsenthil target=_blank></a>
<a class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./github.svg) href=https://github.com/siliconsenthil target=_blank></a>
<a class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./rss.svg) href=https://siliconsenthil.in/index.xml target=_blank></a></nav></div></header><main class="prose prose-neutral relative mx-auto min-h-[calc(100%-10rem)] max-w-3xl px-8 pt-20 pb-32 dark:prose-invert"><article><header class=mb-20><h1 class="!my-0 pb-2.5">VCR - Match body</h1><div class="text-sm opacity-60"><time>Apr 2, 2014</time></div></header><section><p>We had to have make external API calls and we used <a href=https://github.com/vcr/vcr>vcr</a> to record and replay in our integration tests. All was going on well.</p><p>Despite this coverage, we saw our code breaking in production due to small chages in request xml body. We wanted our integration spec to cover these too. By default, vcr <a href=https://www.relishapp.com/vcr/vcr/v/2-0-0-beta1/docs/request-matching>matches</a> request method and url. We wanted it to match the post body too. Simple match by body does not solve as it does plain string match. It would give <a href=http://stackoverflow.com/a/17838775/227705>false negatives</a>.</p><p>So, we decided to match our xml request body. This is what we did.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>gem <span style=color:#e6db74>&#39;equivalent-xml&#39;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>VCR</span><span style=color:#f92672>.</span>configure <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>c<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#some other configs</span>
</span></span><span style=display:flex><span>  c<span style=color:#f92672>.</span>default_cassette_options <span style=color:#f92672>=</span> {<span style=color:#e6db74>record</span>: <span style=color:#e6db74>:once</span>, <span style=color:#e6db74>match_requests_on</span>:  <span style=color:#f92672>[</span><span style=color:#e6db74>:method</span>, <span style=color:#e6db74>:uri</span>, <span style=color:#e6db74>:xml_post_body</span><span style=color:#f92672>]</span>}
</span></span><span style=display:flex><span>  c<span style=color:#f92672>.</span>register_request_matcher <span style=color:#e6db74>:xml_post_body</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>request_1, request_2<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>XmlPostBodyMatcher</span><span style=color:#f92672>.</span>match?(request_1, request_2)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>XmlPostBodyMatcher</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>.</span><span style=color:#a6e22e>match?</span>(request_1, request_2)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span> <span style=color:#66d9ef>if</span> request_1<span style=color:#f92672>.</span>method <span style=color:#f92672>==</span> <span style=color:#e6db74>:get</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>!</span>xml_body?(request_1)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>EquivalentXml</span><span style=color:#f92672>.</span>equivalent?(<span style=color:#66d9ef>Nokogiri</span><span style=color:#f92672>::</span><span style=color:#66d9ef>XML</span>(request_1<span style=color:#f92672>.</span>body), <span style=color:#66d9ef>Nokogiri</span><span style=color:#f92672>::</span><span style=color:#66d9ef>XML</span>(request_2<span style=color:#f92672>.</span>body))
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>We added a new matcher called <code>XmlPostBodyMatcher</code> and it uses <code>equivalent-xml</code> gem to match if the post body is an xml.</p><p>This has helped us to have strict-yet-sensible integration spec and increased our confidence on the test suite.</p><p>Hope this is useful for you too.</p></section><nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]"><a class="flex w-1/2 items-center p-6 pr-3 no-underline" href=https://siliconsenthil.in/blog/2014-06-27-why-scala-why-now/><span class=mr-1.5>←</span><span>Why scala should be your next programming language?</span></a>
<a class="ml-auto flex w-1/2 items-center justify-end p-6 pl-3 no-underline" href=https://siliconsenthil.in/blog/2013-07-11-apache-camel-with-scala-extending-dsl/><span>Apache Camel with Scala: Extending DSL</span><span class=ml-1.5>→</span></a></nav><div id=disqus_thread></div><script>const disqusShortname="siliconsenthil",script=document.createElement("script");script.src="https://"+disqusShortname+".disqus.com/embed.js",script.setAttribute("data-timestamp",+new Date),document.head.appendChild(script)</script></article></main><footer class="opaco mx-auto flex h-[5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"><div class=mr-auto>&copy; 2022
<a class=link href=https://siliconsenthil.in/>siliconsenthil</a></div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>Powered by Hugo️️</a>️
<a class=link href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>▷ Paper 6</a></footer></body></html>
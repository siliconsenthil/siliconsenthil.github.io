<!doctype html><html class="not-ready text-sm lg:text-base" style=--bg:#f1efe1 lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>How we debugged memory leak in a rails app. - siliconsenthil</title><meta name=theme-color><meta name=description content="We run our app on heroku and kept on getting R14s. Our google and stackoverflow skills did provide
few suggestions and but din&rsquo;t help much. We used few tools (rack_bug, oink) see the memory usage. They provided who use how much
but we could make further progress with that. So here&rsquo;s what we did to find out."><meta name=author content><link rel="preload stylesheet" as=style href=https://siliconsenthil.in/main.min.css><script defer src=https://siliconsenthil.in/highlight.min.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=preload as=image href=https://siliconsenthil.in/theme.png><link rel=preload as=image href=https://www.gravatar.com/avatar/b78415ec052d8811a4f31c4746cbde9f><link rel=preload as=image href=https://siliconsenthil.in/twitter.svg><link rel=preload as=image href=https://siliconsenthil.in/github.svg><link rel=preload as=image href=https://siliconsenthil.in/rss.svg><link rel=icon href=https://siliconsenthil.in/favicon.ico><link rel=apple-touch-icon href=https://siliconsenthil.in/apple-touch-icon.png><meta name=generator content="Hugo 0.101.0"><meta property="og:title" content="How we debugged memory leak in a rails app."><meta property="og:description" content="How we debugged memory leak in a rails app."><meta property="og:type" content="article"><meta property="og:url" content="https://siliconsenthil.in/blog/2013-01-19-how-we-debugged-rails-memory-leak/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2013-01-19T13:29:00+05:30"><meta property="article:modified_time" content="2013-01-19T13:29:00+05:30"><meta itemprop=name content="How we debugged memory leak in a rails app."><meta itemprop=description content="How we debugged memory leak in a rails app."><meta itemprop=datePublished content="2013-01-19T13:29:00+05:30"><meta itemprop=dateModified content="2013-01-19T13:29:00+05:30"><meta itemprop=wordCount content="322"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="How we debugged memory leak in a rails app."><meta name=twitter:description content="How we debugged memory leak in a rails app."></head><body class="text-black duration-200 ease-out dark:text-white"><header class="mx-auto flex h-[5rem] max-w-3xl px-8 lg:justify-center"><div class="relative z-50 mr-auto flex items-center"><a class="-translate-x-[1px] -translate-y-0.5 text-3xl font-bold" href=https://siliconsenthil.in/>siliconsenthil</a>
<a class="btn-dark ml-6 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]"></a></div><a class="btn-menu relative z-50 -mr-8 flex h-[5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"></a>
<script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg=`"#f1efe1"`.replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)"),darkVal=localStorage.getItem("dark");setDark(darkVal?darkVal==="true":darkScheme.matches),darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"><nav class="mt-12 flex justify-center space-x-10 dark:invert lg:mt-0 lg:ml-12 lg:items-center lg:space-x-6"><a class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./twitter.svg) href=https://twitter.com/siliconsenthil target=_blank></a>
<a class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./github.svg) href=https://github.com/siliconsenthil target=_blank></a>
<a class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./rss.svg) href=https://siliconsenthil.in/index.xml target=_blank></a></nav></div></header><main class="prose prose-neutral relative mx-auto min-h-[calc(100%-10rem)] max-w-3xl px-8 pt-20 pb-32 dark:prose-invert"><article><header class=mb-20><h1 class="!my-0 pb-2.5">How we debugged memory leak in a rails app.</h1><div class="text-sm opacity-60"><time>Jan 19, 2013</time></div></header><section><p>We run our app on heroku and kept on getting <a href=https://devcenter.heroku.com/articles/error-codes#r14-memory-quota-exceeded>R14</a>s. Our google and stackoverflow skills did provide
few suggestions and but din&rsquo;t help much. We used few tools (<a href=https://github.com/brynary/rack-bug>rack_bug</a>, <a href=https://github.com/noahd1/oink>oink</a>) see the memory usage. They provided who use how much<br>but we could make further progress with that. So here&rsquo;s what we did to find out.</p><ul><li>Figured out what pages create R14<ul><li>Observe pattern of usage</li><li>Load test app with multiple usage paths. Figure out which falls soon.</li></ul></li></ul><p>This is more of finding usage patterns and making guesses. We should ascertain our guess with heavily loading the suspected page(s) and see the memory pattern. We had a page that was most frequently used. We hit it with jmeter and within in minutes it ended up with R14.</p><ul><li>Replicated the leak in local machine.<ul><li>Ran the app in production environment and kept hitting the page.</li><li>Used <code>vmmap</code> to find out memory usage pattern. (You can use <em>smap</em> or <em>pmap</em> as well.)</li><li>Saw the memory usage keep on increasing and never getting stabilized.</li></ul></li></ul><p>When we start the rails app and start visiting pages, the memory goes up. It increases to certain extent and gets stable after
a while. Don't be misguided by the initial increase in memory as memory leak. It happens for all the pages. But, it gets stable soon. For leaking pages, the memory never gets stabilized.</p><ul><li>Drilled down and found the code that leaks.<ul><li>Removed the action and view code and rendered the page and saw memory was stable. This is to ensure
the problem is with the specific page and not the framework as such.</li><li>Added code step-by-step in chunks and observed memory usage.</li><li>Figured out which chunk leaks the memory.</li></ul></li></ul><p><span>Finally, nailed down to <code>model.has_warnings?</code>.</span>
We use <a href=https://github.com/gtd/validation_scopes>validation_scopes</a> which was the cause in our case. It was creating metaclasses for validation
and those classes did not get garbage collected (<a href=/blog/2013/01/19/validation-scopes-leaks-memory/>details</a>).</p><p>We fixed it by replacing <em>validation_scopes</em> with <a href=https://github.com/paneq/activemodel-warnings><em>activemodel-warnings</em></a>.</p></section><nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]"><a class="flex w-1/2 items-center p-6 pr-3 no-underline" href=https://siliconsenthil.in/blog/2013-01-19-validation-scopes-leaks-memory/><span class=mr-1.5>←</span><span>Memory leaks with validation_scopes</span></a>
<a class="ml-auto flex w-1/2 items-center justify-end p-6 pl-3 no-underline" href=https://siliconsenthil.in/blog/2009-09-15-onclick-link-disabling-with-jquery/><span>Onclick link disabling with jQuery</span><span class=ml-1.5>→</span></a></nav><div id=disqus_thread></div><script>const disqusShortname="siliconsenthil",script=document.createElement("script");script.src="https://"+disqusShortname+".disqus.com/embed.js",script.setAttribute("data-timestamp",+new Date),document.head.appendChild(script)</script></article></main><footer class="opaco mx-auto flex h-[5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"><div class=mr-auto>&copy; 2022
<a class=link href=https://siliconsenthil.in/>siliconsenthil</a></div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>Powered by Hugo️️</a>️
<a class=link href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>▷ Paper 6</a></footer></body></html>